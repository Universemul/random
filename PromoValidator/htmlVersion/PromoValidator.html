<!--
	TODO rkeim:
	- add strict validation
	- cleanup code
	- make html pretty
	- add input field
	- add ability to select country
	- add instructions
	- add tips
	- add key
-->

<html>
	<head>
		<title>Promo validator v2.0</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<style>
			table {
				table-layout:fixed;
			}
			
			td {
				width:1px;
				white-space:nowrap;
			}
			
			.outOfStock, .tooExpensive {
				background-color: red;
			}
			
			.tooCheap {
				background-color: orange;
			}
			
			.notFound {
				background-color: yellow;
			}
		</style>
	</head>
	<body>
		<script>
			function getSkusAndExpectedPrices() {
				return [
					{ sku: "PH777HAAA6U3E2ANTH-14510133", price: 5 },
				];
			};
		
			$(document).ready(function(){
				var table = $("#results");
				
				$.each(getSkusAndExpectedPrices(), function() {
					table.append('<tr data-sku="' + this.sku + '"><td>' + this.sku + '</td><td>' + this.price + '</td><td></td><td></td><td></td><td></td><td></td></tr>');
				});
				
				$.each(getSkusAndExpectedPrices(), function() {
				
				var foo = "http://www.lazada.co.th/catalog/?q=" + this.sku;
				
				var origUrl = "http://allorigins.us/get?url=" + encodeURIComponent(foo) + "&callback=?";

				var row = $("[data-sku=\"" + this.sku + "\"]");
				
				$.ajax({
					url: origUrl,
					sku: this.sku
				}).done(function(data) {
					
					var match1 = data.match(/data-sku-simple=\\"PH777HAAA6U3E2ANTH-14510133\\".+?url: '(.+?)'/);
					//                       data-sku-simple=\\"PH777HAAA6U3DMANTH-14510117\\".+?url: '(.+?)'
					
					var tmp = "data-sku-simple=\\\\\"" + this.sku + "\\\\\".+?url: '(.+?)'";

					var match = data.match(tmp);
					
					if (!match)
					{
						row.find(":nth-child(3)").html("N/A");
						row.find(":nth-child(3)").addClass("notFound");
						row.find(":nth-child(4)").html("N/A");
						row.find(":nth-child(4)").addClass("notFound");
						row.find(":nth-child(5)").html("N/A");
						row.find(":nth-child(5)").addClass("notFound");
						row.find(":nth-child(6)").html("Product not found");
						row.find(":nth-child(6)").addClass("notFound");
						return;
					}
					var url = "http://www.lazada.co.th" + match[1];
					
					
					var newUrl = "http://allorigins.us/get?url=" + encodeURIComponent(url) + "&callback=?"
					
					row.find(":nth-child(6)").html("<a href=\"" + url + "\">" + url + "</a>");

					
					$.ajax({
					url: newUrl
				}).done(function(data) {
					var match = data.match(/<span id=\\"product_price\\" class=\\"hidden\\">(.*?)<\/span>/);
					var price = match[1];
					row.find(":nth-child(3)").html(price);
					
					var actualPrice = parseFloat(price);
					var expectedPrice = parseFloat(row.find(":nth-child(2)").html());
					
					if (actualPrice < expectedPrice) {
						row.find(":nth-child(3)").addClass("tooCheap");
					} else if (actualPrice > expectedPrice) {
						row.find(":nth-child(3)").addClass("tooExpensive");
					}
					
					match = data.match(/<h1.*>(.*?)<\/h1>/);
					
					var title = $.trim(match[1].replace(/\\n/g, "").replace("&nbsp;", ""));
					
					row.find(":nth-child(5)").html(title);
					
					match = data.match(/<div class=\\"outofstock oosWrapper\\" style=\\"display: block\\">/);
					
					if (match) {
						var el = row.find(":nth-child(4)");
						el.html("No");
						el.addClass("outOfStock");
					} else {
						row.find(":nth-child(4)").html("Yes");
					}
					
				});
					
				});
				
				});
			});
		</script>
		<table id="results">
			<tr>
				<th>Sku</th>
				<th>Expected price</th>
				<th>Actual price</th>
				<th>Stock available</th>
				<th>Product name</th>
				<th>Url</th>
			</tr>
		</table>
	</body>
</html>