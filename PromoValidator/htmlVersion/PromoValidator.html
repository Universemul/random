<!--
Version history:
	v2.0 -> Re-write in HTML, add out of stock, and product name
	v1.3 -> Fix comparisons for decimal values and cleanup formatting
	v1.2 -> Add support for other countries
	v1.1 -> Fix bug where macro writes in other Excel files
	v1.0 -> Initial version
-->
<html>
	<head>
		<title>Promo validator v2.0</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<style>
			table {
				table-layout:fixed;
			}
			
			td {
				width:1px;
				white-space:nowrap;
			}
			
			.outOfStock, .tooExpensive {
				background-color: red;
			}
			
			.tooCheap {
				background-color: orange;
			}
			
			.notFound {
				background-color: yellow;
			}
		</style>
	</head>
	<body>
		<!-- NOTE: everything is in the same file to facilitate sharing this code with non-developers -->
		<script>
			"use strict";
			
			function getSkusAndExpectedPrices() {
				var input = $.trim($("#input").val());

				return input.split("\n").map(function(line) {
					var split = line.split("\t");
					return { sku: split[0], price: split[1] };
				});
			};
			
			function getLazadaUrl() {
				var value = $("#country").val();
				
				switch (value) {
					case "Thailand":
						return "http://www.lazada.co.th";
					case "Indonesia":
						return "http://www.lazada.co.id";
					case "Philippines":
						return "http://www.lazada.com.ph";
					case "Singapore":
						return "http://www.lazada.sg";
					default:
						throw "Invalid country";
				}
			
				return "http://www.lazada.co.th";
			}
			
			function getCrossDomainUrl(target) {
				return "http://allorigins.us/get?url=" + encodeURIComponent(target) + "&callback=?";
			}
			
			function validatePrices() {
				var table = $("#results");
				var skusAndExpectedPrices = getSkusAndExpectedPrices();
				var lazadaUrl = getLazadaUrl();
				
				// Fill in table with skus to validate
				$.each(skusAndExpectedPrices, function() {
					table.append('<tr data-sku="' + this.sku + '"><td>' + this.sku + '</td><td>' + this.price + '</td><td></td><td></td><td></td><td></td></tr>');
				});
				
				$.each(skusAndExpectedPrices, function() {
					// Do a search to find the product page
					var searchUrl = getCrossDomainUrl(lazadaUrl + "/catalog/?q=" + this.sku);
					var row = $("[data-sku=\"" + this.sku + "\"]");
					
					$.ajax({
						url: searchUrl,
						sku: this.sku
					}).done(function(data) {
						var match = data.match("data-sku-simple=\\\\\"" + this.sku + "\\\\\".+?url: '(.+?)'");
						
						if (!match) {
							var element = row.find(":nth-child(3)");
							element.html("N/A");
							element.addClass("notFound");
							
							element = row.find(":nth-child(4)");
							element.html("N/A");
							element.addClass("notFound");
							
							element = row.find(":nth-child(5)");
							element.html("Product not found");
							element.addClass("notFound");
							
							// Stop processing (because we don't have a product page)
							return;
						}
						
						// Navigate to the product page to find the price and stock availability
						var productPageUrl = lazadaUrl + match[1];
						row.find(":nth-child(1)").html("<a href=\"" + productPageUrl + "\">" + this.sku + "</a>");
						productPageUrl = getCrossDomainUrl(productPageUrl);
						
						$.ajax({
							url: productPageUrl
						}).done(function(data) {
							// Process price
							var match = data.match(/<span id=\\"product_price\\" class=\\"hidden\\">(.*?)<\/span>/);
							var price = match[1];
							row.find(":nth-child(3)").html(price);
							
							var actualPrice = parseFloat(price);
							var expectedPrice = parseFloat(row.find(":nth-child(2)").html());
							
							if (actualPrice < expectedPrice) {
								row.find(":nth-child(3)").addClass("tooCheap");
							} else if (actualPrice > expectedPrice) {
								row.find(":nth-child(3)").addClass("tooExpensive");
							}
							
							// Process product name
							match = data.match(/<h1.*>(.*?)<\/h1>/);
							var title = $.trim(match[1].replace(/\\n/g, "").replace("&nbsp;", ""));
							row.find(":nth-child(5)").html(title);
							
							// Process stock availability
							match = data.match(/<div class=\\"outofstock oosWrapper\\" style=\\"display: block\\">/);
							
							if (match) {
								var el = row.find(":nth-child(4)");
								el.html("No");
								el.addClass("outOfStock");
							} else {
								row.find(":nth-child(4)").html("Yes");
							}
						});
					});
				});
			}
		</script>
		<h1>Instructions</h1>
		<ol>
			<li>Prepare an Excel with two columns (Lazada Sku and expected price)</li>
			<li>Copy/paste values into the form</li>
			<li>Select country</li>
			<li>Click "Validate prices"</li>
		</ol>
		
		<h1>Tips</h1>
		<ul>
			<li>Make sure your computer is plugged in and not running on battery (to make the program run faster)</li>
			<li>Don't try to validate more than 200 skus at once</li>
		</ul>
		
		<h1>Legend</h1>
		<table>
			<tr>
				<td class="notFound">Product not found</td>
			</tr>
			<tr>
				<td class="tooCheap">Price lower than expected</td>
			</tr>
			<tr>
				<td class="tooExpensive">Price higher than expensive or product out of stock</td>
			</tr>
		</table>
		
		<h1>Input</h1>
		Select country:
		<br />
		<select id="country">
			<option value="Thailand">Thailand</option>
			<option value="Indonesia">Indonesia</option>
			<option value="Philippines">Philippines</option>
			<option value="Singapore">Singapore</option>
		</select>
		<br />
		<br />
		Skus and expected prices:
		<br />
		<textarea id="input" rows="10" cols="100"></textarea>
		<br />
		<br />
		<button type="button" onclick="validatePrices()">Validate prices</button>
		
		<h1>Results</h1>
		<table id="results">
			<tr>
				<th>Sku</th>
				<th>Expected price</th>
				<th>Actual price</th>
				<th>Stock available</th>
				<th>Product name</th>
			</tr>
		</table>
	</body>
</html>